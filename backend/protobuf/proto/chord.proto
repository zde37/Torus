syntax = "proto3";

package protogen;

option go_package = "github.com/zde37/torus/backend/protobuf/protogen";

import "google/api/annotations.proto";

// Node represents a node in the Chord ring.
message Node {
  // Node ID as a byte array (160 bits / 20 bytes)
  bytes id = 1;

  // Network host (IP address or hostname)
  string host = 2;

  // Network port (gRPC)
  int32 port = 3;

  // HTTP API port
  int32 http_port = 4;

  // Number of primary user keys stored (excluding Chord metadata and replica keys)
  int32 key_count = 5;

  // Number of replica keys stored on this node
  int32 replica_count = 6;
}

// FindSuccessorRequest asks a node to find the successor of a given ID.
message FindSuccessorRequest {
  // The ID to find the successor for
  bytes id = 1;
}

// FindSuccessorResponse contains the successor node.
message FindSuccessorResponse {
  // The successor node
  Node successor = 1;
}

// FindSuccessorWithPathRequest asks a node to find the successor with path tracking.
message FindSuccessorWithPathRequest {
  // The ID to find the successor for
  bytes id = 1;
}

// FindSuccessorWithPathResponse contains the successor and path from this node onwards.
message FindSuccessorWithPathResponse {
  // The successor node
  Node successor = 1;

  // Path taken from this node onwards (includes this node)
  repeated Node path = 2;
}

// GetPredecessorRequest asks a node for its predecessor.
message GetPredecessorRequest {
  // Empty - no parameters needed
}

// GetPredecessorResponse contains the predecessor node.
message GetPredecessorResponse {
  // The predecessor node (may be nil if not set)
  Node predecessor = 1;
}

// NotifyRequest notifies a node that another node might be its predecessor.
message NotifyRequest {
  // The node that might be the predecessor
  Node node = 1;
}

// NotifyResponse acknowledges the notification.
message NotifyResponse {
  // Success indicator
  bool success = 1;
}

// GetSuccessorListRequest asks a node for its successor list.
message GetSuccessorListRequest {
  // Empty - no parameters needed
}

// GetSuccessorListResponse contains the successor list.
message GetSuccessorListResponse {
  // List of successor nodes
  repeated Node successors = 1;
}

// PingRequest is used for health checks.
message PingRequest {
  // Optional message
  string message = 1;
}

// PingResponse acknowledges the ping.
message PingResponse {
  // Response message
  string message = 1;

  // Timestamp of the response
  int64 timestamp = 2;
}

// GetNodeInfoRequest asks for the node's information.
message GetNodeInfoRequest {
  // Empty - no parameters needed
}

// GetNodeInfoResponse contains the node's information.
message GetNodeInfoResponse {
  // The node's information
  Node node = 1;
}

// GetRequest retrieves a value by key from the DHT.
message GetRequest {
  // The key to retrieve
  string key = 1;
}

// GetResponse contains the retrieved value.
message GetResponse {
  // The value (empty if not found)
  bytes value = 1;

  // Whether the key was found
  bool found = 2;
}

// SetRequest stores a key-value pair in the DHT.
message SetRequest {
  // The key to store
  string key = 1;

  // The value to store
  bytes value = 2;

  // TTL in seconds (0 = no expiration)
  int64 ttl_seconds = 3;
}

// SetResponse acknowledges the set operation.
message SetResponse {
  // Success indicator
  bool success = 1;
}

// DeleteRequest removes a key from the DHT.
message DeleteRequest {
  // The key to delete
  string key = 1;
}

// DeleteResponse acknowledges the delete operation.
message DeleteResponse {
  // Success indicator
  bool success = 1;
}

// SetReplicaRequest stores a replica of a key on a successor node.
message SetReplicaRequest {
  // The key to replicate
  string key = 1;

  // The value to replicate
  bytes value = 2;

  // TTL in seconds (0 = no expiration)
  int64 ttl_seconds = 3;
}

// SetReplicaResponse acknowledges the replica storage.
message SetReplicaResponse {
  // Success indicator
  bool success = 1;
}

// GetReplicaRequest retrieves a replica of a key.
message GetReplicaRequest {
  // The key to retrieve
  string key = 1;
}

// GetReplicaResponse contains the replica value.
message GetReplicaResponse {
  // The value (empty if not found)
  bytes value = 1;

  // Whether the replica was found
  bool found = 2;
}

// DeleteReplicaRequest removes a replica of a key.
message DeleteReplicaRequest {
  // The key to delete
  string key = 1;
}

// DeleteReplicaResponse acknowledges the replica deletion.
message DeleteReplicaResponse {
  // Success indicator
  bool success = 1;
}

// ClosestPrecedingFingerRequest asks for the closest preceding finger.
message ClosestPrecedingFingerRequest {
  // The ID to find the closest preceding finger for
  bytes id = 1;
}

// ClosestPrecedingFingerResponse contains the closest preceding node.
message ClosestPrecedingFingerResponse {
  // The closest preceding node
  Node node = 1;
}

// TransferKeysRequest asks a node to transfer keys in a range.
message TransferKeysRequest {
  // Start of the range (exclusive)
  bytes start_id = 1;

  // End of the range (inclusive)
  bytes end_id = 2;
}

// KeyValuePair represents a single key-value pair.
message KeyValuePair {
  // The key
  string key = 1;

  // The value
  bytes value = 2;

  // TTL remaining in seconds (0 = no expiration)
  int64 ttl_seconds = 3;
}

// TransferKeysResponse contains the keys in the requested range.
message TransferKeysResponse {
  // List of key-value pairs
  repeated KeyValuePair keys = 1;

  // Number of keys transferred
  int32 count = 2;
}

// DeleteTransferredKeysRequest asks a node to delete keys in a range.
message DeleteTransferredKeysRequest {
  // Start of the range (exclusive)
  bytes start_id = 1;

  // End of the range (inclusive)
  bytes end_id = 2;
}

// DeleteTransferredKeysResponse confirms deletion.
message DeleteTransferredKeysResponse {
  // Whether deletion was successful
  bool success = 1;

  // Number of keys deleted
  int32 count = 2;
}

// LookupPathRequest asks a node to find a key and return the path taken.
message LookupPathRequest {
  // The key to lookup
  string key = 1;
}

// LookupPathResponse contains the lookup result and path taken.
message LookupPathResponse {
  // The key that was looked up
  string key = 1;

  // Hash of the key
  bytes key_hash = 2;

  // The node responsible for this key
  Node responsible_node = 3;

  // List of nodes visited during the lookup (in order)
  repeated Node path = 4;

  // Number of hops taken
  int32 hops = 5;
}

// GetFingerTableRequest asks a node for its finger table.
message GetFingerTableRequest {
  // Empty - no parameters needed
}

// FingerTableEntry represents a single entry in the finger table.
message FingerTableEntry {
  // Start of the interval: (n + 2^(i-1)) mod 2^M
  bytes start = 1;

  // The node that succeeds or equals start
  Node node = 2;

  // Index in the finger table (0 to M-1)
  int32 index = 3;
}

// GetFingerTableResponse contains the node's finger table.
message GetFingerTableResponse {
  // List of finger table entries
  repeated FingerTableEntry entries = 1;
}

// BulkStoreRequest contains multiple key-value pairs to store.
message BulkStoreRequest {
  // Map of keys to values
  map<string, bytes> items = 1;
}

// BulkStoreResponse confirms bulk storage.
message BulkStoreResponse {
  // Whether the operation was successful
  bool success = 1;

  // Number of items stored
  int32 count = 2;

  // Optional error message for failed items
  string error = 3;
}

// NotifyPredecessorLeavingRequest notifies predecessor about node leaving.
message NotifyPredecessorLeavingRequest {
  // The new successor after the leaving node
  Node new_successor = 1;
}

// NotifyPredecessorLeavingResponse acknowledges the notification.
message NotifyPredecessorLeavingResponse {
  // Whether the notification was processed successfully
  bool success = 1;
}

// NotifySuccessorLeavingRequest notifies successor about node leaving.
message NotifySuccessorLeavingRequest {
  // The new predecessor after the leaving node
  Node new_predecessor = 1;
}

// NotifySuccessorLeavingResponse acknowledges the notification.
message NotifySuccessorLeavingResponse {
  // Whether the notification was processed successfully
  bool success = 1;
}

// NotifyNodeLeavingRequest notifies a node about another node leaving.
message NotifyNodeLeavingRequest {
  // The node that is leaving
  Node leaving_node = 1;
}

// NotifyNodeLeavingResponse acknowledges the notification.
message NotifyNodeLeavingResponse {
  // Whether the notification was processed successfully
  bool success = 1;
}

// ChordService defines the gRPC service for Chord protocol operations.
service ChordService {
  // FindSuccessor finds the successor of a given ID.
  // This is the core Chord lookup operation.
  rpc FindSuccessor(FindSuccessorRequest) returns (FindSuccessorResponse);

  // FindSuccessorWithPath finds the successor and returns the routing path.
  // This is used internally for path tracking between nodes.
  rpc FindSuccessorWithPath(FindSuccessorWithPathRequest) returns (FindSuccessorWithPathResponse);

  // GetPredecessor returns the node's predecessor.
  rpc GetPredecessor(GetPredecessorRequest) returns (GetPredecessorResponse) {
    option (google.api.http) = {
      get: "/api/node/predecessor"
    };
  }

  // Notify informs a node that another node might be its predecessor.
  // Used during stabilization.
  rpc Notify(NotifyRequest) returns (NotifyResponse);

  // GetSuccessorList returns the node's successor list.
  // Used for fault tolerance.
  rpc GetSuccessorList(GetSuccessorListRequest) returns (GetSuccessorListResponse) {
    option (google.api.http) = {
      get: "/api/node/successors"
    };
  }

  // Ping checks if a node is alive.
  rpc Ping(PingRequest) returns (PingResponse) {
    option (google.api.http) = {
      get: "/api/node/ping"
    };
  }

  // GetNodeInfo returns the node's information (ID, host, port).
  // Used to get bootstrap node details before joining.
  rpc GetNodeInfo(GetNodeInfoRequest) returns (GetNodeInfoResponse) {
    option (google.api.http) = {
      get: "/api/node/info"
    };
  }

  // ClosestPrecedingFinger returns the closest finger preceding an ID.
  // Used during lookup to optimize the search.
  rpc ClosestPrecedingFinger(ClosestPrecedingFingerRequest) returns (ClosestPrecedingFingerResponse);

  // TransferKeys transfers keys in a given ID range.
  // Used during node join to transfer ownership.
  rpc TransferKeys(TransferKeysRequest) returns (TransferKeysResponse);

  // DeleteTransferredKeys deletes keys in a given ID range.
  // Used after successful key transfer to clean up duplicates.
  rpc DeleteTransferredKeys(DeleteTransferredKeysRequest) returns (DeleteTransferredKeysResponse);

  // Get retrieves a value by key from the DHT.
  rpc Get(GetRequest) returns (GetResponse) {
    option (google.api.http) = {
      get: "/api/keys/{key}"
    };
  }

  // Set stores a key-value pair in the DHT.
  rpc Set(SetRequest) returns (SetResponse) {
    option (google.api.http) = {
      post: "/api/keys"
      body: "*"
    };
  }

  // Delete removes a key from the DHT.
  rpc Delete(DeleteRequest) returns (DeleteResponse) {
    option (google.api.http) = {
      delete: "/api/keys/{key}"
    };
  }

  // LookupPath finds the node responsible for a key and returns the path taken.
  // Used for visualization and debugging.
  rpc LookupPath(LookupPathRequest) returns (LookupPathResponse) {
    option (google.api.http) = {
      get: "/api/lookup/{key}"
    };
  }

  // GetFingerTable returns the node's finger table.
  // Used for visualization.
  rpc GetFingerTable(GetFingerTableRequest) returns (GetFingerTableResponse) {
    option (google.api.http) = {
      get: "/api/node/fingers"
    };
  }

  // SetReplica stores a replica of a key on a successor node.
  // Used for data replication to provide fault tolerance.
  rpc SetReplica(SetReplicaRequest) returns (SetReplicaResponse);

  // GetReplica retrieves a replica of a key.
  // Used as fallback when primary node fails.
  rpc GetReplica(GetReplicaRequest) returns (GetReplicaResponse);

  // DeleteReplica removes a replica of a key.
  // Used to maintain consistency when deleting keys.
  rpc DeleteReplica(DeleteReplicaRequest) returns (DeleteReplicaResponse);

  // BulkStore stores multiple key-value pairs efficiently.
  // Used during node leave for bulk key transfer.
  rpc BulkStore(BulkStoreRequest) returns (BulkStoreResponse);

  // NotifyPredecessorLeaving notifies predecessor about node leaving.
  // Used during graceful shutdown to update ring topology.
  rpc NotifyPredecessorLeaving(NotifyPredecessorLeavingRequest) returns (NotifyPredecessorLeavingResponse);

  // NotifySuccessorLeaving notifies successor about node leaving.
  // Used during graceful shutdown to update ring topology.
  rpc NotifySuccessorLeaving(NotifySuccessorLeavingRequest) returns (NotifySuccessorLeavingResponse);

  // NotifyNodeLeaving notifies any node about another node leaving.
  // Used to inform successor list members during graceful shutdown.
  rpc NotifyNodeLeaving(NotifyNodeLeavingRequest) returns (NotifyNodeLeavingResponse);
}
